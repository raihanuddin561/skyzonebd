// B2B Ecommerce Database Schema
// Database: sagor_db (PostgreSQL)

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// User Management - Simple Registration
model User {
  id          String   @id @default(cuid())
  email       String   @unique
  name        String // Required
  phone       String? // Optional (mobile)
  companyName String? // Optional - can add later
  password    String
  role        UserRole @default(BUYER)
  userType    UserType @default(WHOLESALE)
  isActive    Boolean  @default(true)
  isVerified  Boolean  @default(false) // Optional business verification

  // Customer Discount (Special Offer)
  discountPercent    Float?    @default(0) // Special discount % for this customer (0-100)
  discountReason     String? // Reason for discount (e.g., "VIP Customer", "Annual Contract")
  discountValidUntil DateTime? // Optional expiration date for discount

  // Profit Sharing Configuration (for sellers/partners)
  profitSharePercentage Float? // Percentage of profit this seller/partner receives
  isProfitPartner       Boolean @default(false) // Is this user a profit-sharing partner?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Business Information (Optional - can complete from profile later)
  businessInfo BusinessInfo?

  // Relations
  orders               Order[]
  addresses            Address[]
  rfqs                 RFQ[]
  products             Product[] // Products created/managed by this user (seller)
  activityLogs         ActivityLog[] // Admin activity logs
  dataDeletionRequests DataDeletionRequest[] // GDPR data deletion requests
  permissions          UserPermission[] // Granular permissions for this user
  sales                Sale[] // Sales where this user is the customer
  salesEntered         Sale[]                @relation("SaleEnteredBy") // Sales entered by this admin
  reviews              Review[] // Product reviews by this user
  manualSalesAsCustomer ManualSalesEntry[]  @relation("ManualSalesCustomer") // Manual sales where this user is the customer
  manualSalesEntered    ManualSalesEntry[]  @relation("SaleEnteredBy") // Manual sales entered by this admin

  @@map("users")
}

// User Permissions - Granular Access Control
model UserPermission {
  id         String           @id @default(cuid())
  userId     String
  module     PermissionModule // Which module/feature
  canView    Boolean          @default(false)
  canCreate  Boolean          @default(false)
  canEdit    Boolean          @default(false)
  canDelete  Boolean          @default(false)
  canApprove Boolean          @default(false) // For approval workflows
  canExport  Boolean          @default(false) // Export data

  grantedBy String? // Admin who granted this permission
  grantedAt DateTime  @default(now())
  expiresAt DateTime? // Optional expiration

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, module])
  @@index([userId])
  @@index([module])
  @@map("user_permissions")
}

enum PermissionModule {
  // Inventory Management
  INVENTORY_VIEW
  INVENTORY_MANAGE
  INVENTORY_REPORTS

  // Employee Management
  EMPLOYEES_VIEW
  EMPLOYEES_MANAGE
  EMPLOYEES_REPORTS

  // Salary Management
  SALARIES_VIEW
  SALARIES_MANAGE
  SALARIES_PROCESS
  SALARIES_APPROVE

  // Operational Costs
  COSTS_VIEW
  COSTS_MANAGE
  COSTS_APPROVE

  // Profit & Loss
  PROFIT_LOSS_VIEW
  PROFIT_LOSS_REPORTS

  // Products
  PRODUCTS_VIEW
  PRODUCTS_MANAGE

  // Orders
  ORDERS_VIEW
  ORDERS_MANAGE
  ORDERS_PROCESS

  // Customers
  CUSTOMERS_VIEW
  CUSTOMERS_MANAGE

  // Categories
  CATEGORIES_VIEW
  CATEGORIES_MANAGE

  // Users & Permissions
  USERS_VIEW
  USERS_MANAGE
  PERMISSIONS_MANAGE

  // System Settings
  SETTINGS_VIEW
  SETTINGS_MANAGE

  // Reports & Analytics
  REPORTS_VIEW
  REPORTS_EXPORT
  ANALYTICS_VIEW
}

// Business Information (Optional - can complete from profile)
model BusinessInfo {
  id                   String             @id @default(cuid())
  userId               String             @unique
  companyType          String? // Optional: Retailer, Distributor, Manufacturer, Reseller
  registrationNumber   String? // Optional
  taxId                String? // Optional
  website              String?
  employeeCount        String?
  annualPurchaseVolume String?
  tradeLicenseUrl      String? // Optional: Trade license document
  taxCertificateUrl    String? // Optional: Tax certificate/TIN certificate
  verificationStatus   VerificationStatus @default(PENDING)
  verifiedAt           DateTime?

  // Additional Business Information (Optional)
  businessAddress     String?
  businessCity        String?
  businessCountry     String  @default("Bangladesh")
  shippingPreferences String? // Bulk/Pallet/Container shipping
  paymentTerms        String? // Payment terms preference
  creditLimit         Float? // Maximum credit allowed

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("business_info")
}

model Address {
  id         String      @id @default(cuid())
  userId     String
  type       AddressType @default(SHIPPING)
  street     String
  city       String
  state      String?
  postalCode String?
  country    String      @default("Bangladesh")
  isDefault  Boolean     @default(false)
  createdAt  DateTime    @default(now())
  updatedAt  DateTime    @updatedAt

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("addresses")
}

// Unit Management
// Stores measurement units for products (kg, liter, piece, etc.)
model Unit {
  id          String   @id @default(cuid())
  name        String   @unique // e.g., "Piece", "Kilogram", "Liter"
  symbol      String   @unique // e.g., "pcs", "kg", "L"
  description String?
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("units")
}

// Product Management
model Category {
  id          String   @id @default(cuid())
  name        String   @unique
  slug        String   @unique
  description String?
  imageUrl    String?
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  products Product[]

  @@map("categories")
}

model Product {
  id          String  @id @default(cuid())
  name        String
  slug        String  @unique
  description String?

  // Images (Vercel Blob URLs)
  imageUrl     String // Primary product image
  imageUrls    String[] @default([]) // Additional images (gallery)
  thumbnailUrl String? // Optimized thumbnail

  // Product Details
  brand          String?
  tags           String[] @default([])
  specifications Json? // Flexible specifications as JSON
  unit           String? // Unit of measurement (stores unit symbol) - optional

  // WHOLESALE PRICING ONLY
  basePrice      Float // Base cost price (what platform pays)
  wholesalePrice Float // Selling price to wholesale customers
  moq            Int? // Minimum Order Quantity (optional)

  // Profit Calculation
  platformProfitPercentage Float  @default(15) // Admin-controlled profit %
  calculatedProfit         Float? // Auto-calculated: (wholesalePrice - basePrice) * platformProfitPercentage/100
  sellerProfit             Float? // Profit allocated to seller/partner

  // Inventory Management
  stockQuantity   Int       @default(0)
  reorderLevel    Int       @default(20) // Alert when stock reaches this level
  reorderQuantity Int       @default(100) // Suggested reorder quantity
  availability    String    @default("in_stock") // in_stock, limited, out_of_stock, pre_order
  sku             String?   @unique
  batchNumber     String? // For batch tracking
  expiryDate      DateTime? // For perishable goods

  // Cost Tracking
  costPerUnit  Float? // Actual cost per unit (for profit calculation)
  shippingCost Float? // Shipping cost per unit
  handlingCost Float? // Handling/storage cost per unit

  // Seller Information (For multi-vendor/partner model)
  sellerId                   String? // Partner who supplies this product
  sellerCommissionPercentage Float? // Partner's commission percentage

  // Metadata
  categoryId  String
  isActive    Boolean @default(true)
  isFeatured  Boolean @default(false)
  rating      Float?
  reviewCount Int     @default(0)

  // Wholesale Preferences
  allowSamples           Boolean @default(false) // Allow sample orders
  sampleMOQ              Int     @default(1) // MOQ for samples
  samplePrice            Float? // Price per sample unit
  customizationAvailable Boolean @default(false) // Can be customized

  // Tax Configuration
  taxRate         Float?  // Tax rate percentage (e.g., 15 for 15%)
  taxInclusive    Boolean @default(false) // Is wholesalePrice tax-inclusive?
  taxCategory     String? // Standard, Reduced, Zero, Exempt

  // SEO
  metaTitle       String?
  metaDescription String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  category       Category        @relation(fields: [categoryId], references: [id])
  seller         User?           @relation(fields: [sellerId], references: [id], onDelete: SetNull)
  orderItems     OrderItem[]
  wholesaleTiers WholesaleTier[] // Volume-based pricing
  rfqItems       RFQItem[]
  heroSlides     HeroSlide[]
  inventoryLogs  InventoryLog[] // Track inventory changes
  profitReports  ProfitReport[] // Profit analysis per product
  sales          Sale[] // Sales records for this product
  reviews        Review[] // Product reviews
  stockLots      StockLot[] // Stock lots for FIFO/WAC costing
  manualSalesItems ManualSalesItem[] // Manual sales entries

  @@map("products")
}

// Wholesale Pricing Tiers for Volume-based Discounts
model WholesaleTier {
  id          String @id @default(cuid())
  productId   String
  minQuantity Int // Minimum quantity for this tier
  maxQuantity Int? // null means unlimited/highest tier
  price       Float // Price per unit at this tier
  discount    Float // Percentage discount from base wholesale price

  // Profit calculation for this tier
  profitMargin Float? // Profit margin % at this tier

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@unique([productId, minQuantity])
  @@map("wholesale_tiers")
}

// Order Management
model Order {
  id          String  @id @default(cuid())
  orderNumber String  @unique
  userId      String? // Optional - nullable for guest orders

  // Guest Order Information
  guestName  String?
  guestPhone String? // Required for guest
  guestEmail String?

  // Order Details
  subtotal Float
  tax      Float @default(0)
  shipping Float @default(0)
  total    Float

  // Profit Tracking
  totalCost      Float? // Total cost of goods
  grossProfit    Float? // Total revenue - total cost
  platformProfit Float? // Platform's share of profit
  sellerProfit   Float? // Seller's/Partner's share
  profitMargin   Float? // Profit margin percentage

  // Status
  status        OrderStatus   @default(PENDING)
  paymentStatus PaymentStatus @default(PENDING)
  paymentMethod String

  // Cancellation
  cancelledAt        DateTime?
  cancelledBy        String? // userId of who cancelled (admin or customer)
  cancellationReason String?

  // Addresses
  shippingAddress String
  billingAddress  String

  // Wholesale Specific
  purchaseOrderNumber String? // Customer's PO number
  deliveryDate        DateTime? // Requested delivery date
  paymentTerms        String? // NET30, NET60, etc.
  invoiceUrl          String? // Generated invoice PDF URL

  // Notes
  notes         String?
  internalNotes String? // Admin/seller notes (not visible to customer)

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  user          User?          @relation(fields: [userId], references: [id])
  orderItems    OrderItem[]
  payments      Payment[]
  profitReports ProfitReport[]
  sales         Sale[] // Sales generated from this order
  reviews       Review[] // Reviews for products in this order
  ledgerEntries FinancialLedger[] // Financial ledger entries for this order

  @@index([status, createdAt])
  @@index([status, updatedAt])
  @@index([userId, status])
  @@index([createdAt])
  @@map("orders")
}

model OrderItem {
  id        String @id @default(cuid())
  orderId   String
  productId String
  quantity  Int
  price     Float // Price per unit at time of order
  total     Float // quantity * price

  // Profit Tracking per Item
  costPerUnit   Float? // Cost per unit at time of order
  profitPerUnit Float? // Profit per unit
  totalProfit   Float? // Total profit for this line item
  profitMargin  Float? // Profit margin % for this item

  createdAt DateTime @default(now())

  // Relations
  order   Order   @relation(fields: [orderId], references: [id], onDelete: Cascade)
  product Product @relation(fields: [productId], references: [id])

  @@index([productId, createdAt])
  @@index([orderId, productId])
  @@map("order_items")
}

// Payment Management
model Payment {
  id            String        @id @default(cuid())
  orderId       String
  
  // Payment Details
  amount        Float
  method        PaymentMethod
  status        PaymentStatus @default(PENDING)
  
  // Gateway Information
  transactionId String?       @unique
  gateway       String? // bKash, Nagad, Bank, etc.
  gatewayRef    String? // Gateway transaction reference
  gatewayResponse Json? // Full gateway response for audit
  
  // Timestamps
  paidAt        DateTime?     // When payment was received
  confirmedAt   DateTime?     // When payment was confirmed
  
  // People
  receivedBy    String?       // Admin/employee who received payment
  approvedBy    String?       // Admin who approved payment
  
  // Metadata
  notes         String?
  attachmentUrl String?       // Receipt/proof of payment
  
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt

  // Relations
  order Order @relation(fields: [orderId], references: [id], onDelete: Cascade)

  @@index([orderId])
  @@index([status])
  @@index([paidAt])
  @@map("payments")
}

// Request for Quote (B2B Feature)
model RFQ {
  id          String    @id @default(cuid())
  rfqNumber   String    @unique
  userId      String
  subject     String
  message     String?
  targetPrice Float?
  status      RFQStatus @default(PENDING)
  expiresAt   DateTime?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  // Relations
  user  User      @relation(fields: [userId], references: [id])
  items RFQItem[]

  @@map("rfqs")
}

model RFQItem {
  id        String   @id @default(cuid())
  rfqId     String
  productId String
  quantity  Int
  notes     String?
  createdAt DateTime @default(now())

  // Relations
  rfq     RFQ     @relation(fields: [rfqId], references: [id], onDelete: Cascade)
  product Product @relation(fields: [productId], references: [id])

  @@map("rfq_items")
}

// Enums
enum UserRole {
  SUPER_ADMIN // Level 5 - Full system control + override capabilities
  ADMIN // Level 4 - Full management access
  PARTNER // Level 3 - Partner/Investor level access + profit viewing
  MANAGER // Level 2 - Department/team management
  SELLER // Level 1.5 - Can sell and manage own products
  BUYER // Level 1 - Standard customer access
  GUEST // Level 0 - Limited guest access
}

enum UserType {
  RETAIL // Retail customers (individual buyers)
  WHOLESALE // Wholesale/Business customers
  SELLER // Sellers/Suppliers
  ADMIN // Platform administrators
  GUEST // Guest checkout with mobile + address only
}

enum VerificationStatus {
  PENDING
  APPROVED
  REJECTED
  RESUBMIT
}

enum RFQStatus {
  PENDING
  QUOTED
  ACCEPTED
  REJECTED
  EXPIRED
}

enum AddressType {
  SHIPPING
  BILLING
}

enum OrderStatus {
  PENDING
  CONFIRMED
  PROCESSING
  PACKED
  SHIPPED
  IN_TRANSIT
  DELIVERED
  CANCELLED
  RETURNED
  REFUNDED
}

enum PaymentStatus {
  PENDING
  PAID
  PARTIAL
  FAILED
  REFUNDED
}

enum PaymentMethod {
  BANK_TRANSFER
  BKASH
  NAGAD
  ROCKET
  CREDIT_CARD
  INVOICE_NET30 // Wholesale payment terms
  INVOICE_NET60
  INVOICE_NET90
  LC // Letter of Credit for large orders
}

enum InventoryAction {
  PURCHASE // Stock added from supplier
  SALE // Stock reduced from order
  RETURN // Stock returned from customer
  ADJUSTMENT // Manual adjustment by admin
  DAMAGE // Damaged stock write-off
  EXPIRED // Expired stock write-off
  TRANSFER // Stock transfer between warehouses
  RECOUNT // Physical inventory recount
}

// Hero Slider for Homepage
model HeroSlide {
  id         String   @id @default(cuid())
  title      String
  subtitle   String?
  imageUrl   String // Main banner image
  linkUrl    String? // Link to product or category
  productId  String? // Optional: Link to specific product
  buttonText String   @default("Shop Now")
  position   Int      @default(0) // Order of slides
  isActive   Boolean  @default(true)
  bgColor    String   @default("#3B82F6") // Background color (hex)
  textColor  String   @default("#FFFFFF") // Text color (hex)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  // Relations
  product Product? @relation(fields: [productId], references: [id], onDelete: SetNull)

  @@index([position])
  @@index([isActive])
  @@map("hero_slides")
}

// Admin Activity Tracking
model ActivityLog {
  id          String         @id @default(cuid())
  userId      String // Admin who performed the action
  userName    String // Store name for quick reference
  action      ActivityAction // Type of action performed
  entityType  String // Product, Order, Category, User, etc.
  entityId    String? // ID of the affected entity
  entityName  String? // Name/title of the affected entity
  description String // Human-readable description
  metadata    Json? // Additional data (old values, new values, etc.)
  ipAddress   String? // IP address of the admin
  userAgent   String? // Browser/device info
  createdAt   DateTime       @default(now())

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([action])
  @@index([entityType])
  @@index([createdAt])
  @@map("activity_logs")
}

enum ActivityAction {
  CREATE
  UPDATE
  DELETE
  STATUS_CHANGE
  CANCEL
  RESTORE
  EXPORT
  IMPORT
  LOGIN
  LOGOUT
}

enum DeletionRequestStatus {
  PENDING
  PROCESSING
  COMPLETED
  REJECTED
  CANCELLED
}

// Inventory Management System
model InventoryLog {
  id            String          @id @default(cuid())
  productId     String
  action        InventoryAction
  quantity      Int // Positive for additions, negative for reductions
  previousStock Int // Stock before action
  newStock      Int // Stock after action
  reference     String? // Order ID, PO number, etc.
  notes         String?
  performedBy   String? // User ID who performed the action
  createdAt     DateTime        @default(now())

  // Relations
  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@index([productId])
  @@index([action])
  @@index([createdAt])
  @@map("inventory_logs")
}

// Profit Sharing & Reporting
model ProfitReport {
  id        String  @id @default(cuid())
  orderId   String
  productId String? // Null for order-level report

  // Revenue & Cost
  revenue     Float // Total sales revenue
  costOfGoods Float // Total cost of goods sold
  grossProfit Float // Revenue - Cost

  // Expenses
  shippingExpense  Float @default(0)
  handlingExpense  Float @default(0)
  platformExpense  Float @default(0) // Platform operational costs
  marketingExpense Float @default(0)
  otherExpenses    Float @default(0)
  totalExpenses    Float // Sum of all expenses

  // Net Profit
  netProfit    Float // Gross profit - Total expenses
  profitMargin Float // (Net profit / Revenue) * 100

  // Profit Distribution
  platformProfit        Float // Platform's share
  platformProfitPercent Float // Platform profit percentage (set by admin)
  sellerProfit          Float // Seller/Partner's share
  sellerProfitPercent   Float // Seller profit percentage
  sellerId              String? // Partner/Seller who gets the share

  // Period
  reportPeriod String? // Daily, Weekly, Monthly, etc.
  reportDate   DateTime @default(now())

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  order   Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)
  product Product? @relation(fields: [productId], references: [id], onDelete: SetNull)

  @@index([orderId])
  @@index([productId])
  @@index([reportDate])
  @@map("profit_reports")
}

// Platform Configuration for Profit Sharing
model PlatformConfig {
  id          String  @id @default(cuid())
  key         String  @unique // Configuration key
  value       String // Configuration value (JSON string for complex values)
  description String?
  category    String  @default("general") // general, profit, inventory, etc.

  // Common profit sharing configs:
  // - default_platform_profit_percentage
  // - default_seller_profit_percentage
  // - minimum_order_value
  // - maximum_credit_limit
  // - reorder_notification_enabled

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("platform_config")
}

// Warehouse/Location Management (for multi-location inventory)
model Warehouse {
  id            String  @id @default(cuid())
  name          String
  code          String  @unique // Warehouse code (e.g., WH-DHK-01)
  address       String
  city          String
  country       String  @default("Bangladesh")
  contactPerson String?
  contactPhone  String?
  isActive      Boolean @default(true)
  isPrimary     Boolean @default(false) // Primary warehouse
  capacity      Int? // Storage capacity
  currentLoad   Int? // Current storage utilization

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("warehouses")
}

// Sales Tracking System - Tracks both direct sales and order-based sales
model Sale {
  id       String   @id @default(cuid())
  saleType SaleType // DIRECT or ORDER_BASED
  saleDate DateTime @default(now())

  // Reference
  orderId       String? // Reference to order if ORDER_BASED
  invoiceNumber String? // Invoice/receipt number

  // Customer Information
  customerName  String
  customerPhone String?
  customerEmail String?
  customerId    String? // Reference to user if registered customer

  // Product Details
  productId   String
  productName String // Snapshot of product name at time of sale
  productSku  String?
  quantity    Int
  unitPrice   Float // Price per unit at time of sale
  totalAmount Float // quantity × unitPrice

  // Cost & Profit
  costPrice    Float? // Cost per unit (for profit calculation)
  profitAmount Float? // (unitPrice - costPrice) × quantity
  profitMargin Float? // (profitAmount / totalAmount) × 100

  // Payment Information
  paymentMethod String? // Cash, Card, Bank Transfer, Mobile Banking, etc.
  paymentStatus PaymentStatus @default(PAID)

  // Additional Information
  notes       String? // Additional notes
  enteredBy   String? // Admin user ID who entered the sale
  isDelivered Boolean @default(true) // True for direct sales, depends on order for order-based

  // Relations
  product       Product @relation(fields: [productId], references: [id])
  order         Order?  @relation(fields: [orderId], references: [id])
  customer      User?   @relation(fields: [customerId], references: [id])
  enteredByUser User?   @relation("SaleEnteredBy", fields: [enteredBy], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([saleType])
  @@index([saleDate])
  @@index([orderId])
  @@index([customerId])
  @@index([productId])
  @@index([paymentStatus])
  @@map("sales")
}

enum SaleType {
  DIRECT // Direct sale entered manually by admin
  ORDER_BASED // Sale generated from delivered order
}

// Employee Management
model Employee {
  id          String    @id @default(cuid())
  employeeId  String    @unique // Custom employee ID (e.g., EMP-001)
  firstName   String
  lastName    String
  email       String    @unique
  phone       String
  dateOfBirth DateTime?
  gender      String?
  address     String?
  city        String?
  country     String    @default("Bangladesh")

  // Employment Details
  department      String // Sales, Operations, IT, HR, Finance, etc.
  designation     String // Manager, Associate, Executive, etc.
  employmentType  EmploymentType @default(FULL_TIME)
  joiningDate     DateTime
  resignationDate DateTime?
  isActive        Boolean        @default(true)

  // Salary Information
  baseSalary Float // Monthly base salary
  allowances Float @default(0) // Housing, transport, etc.
  bonuses    Float @default(0) // Performance bonuses

  // Emergency Contact
  emergencyContact String?
  emergencyPhone   String?

  // Documents
  nidNumber   String? // National ID
  tinNumber   String? // Tax Identification Number
  bankAccount String?
  bankName    String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  salaries    Salary[]
  attendances Attendance[]

  @@index([employeeId])
  @@index([department])
  @@index([isActive])
  @@map("employees")
}

enum EmploymentType {
  FULL_TIME
  PART_TIME
  CONTRACT
  INTERN
  FREELANCE
}

// Salary Records
model Salary {
  id         String   @id @default(cuid())
  employeeId String
  employee   Employee @relation(fields: [employeeId], references: [id], onDelete: Cascade)

  // Salary Period
  month Int // 1-12
  year  Int

  // Salary Components
  baseSalary  Float
  allowances  Float @default(0)
  bonuses     Float @default(0)
  overtime    Float @default(0)
  grossSalary Float // baseSalary + allowances + bonuses + overtime

  // Deductions
  tax             Float @default(0)
  providentFund   Float @default(0)
  insurance       Float @default(0)
  loan            Float @default(0)
  otherDeductions Float @default(0)
  totalDeductions Float // Sum of all deductions

  // Net Salary
  netSalary Float // grossSalary - totalDeductions

  // Payment Details
  paymentStatus    PaymentStatus @default(PENDING)
  paymentDate      DateTime?
  paymentMethod    String? // Bank Transfer, Cash, Cheque
  paymentReference String? // Transaction ID or Cheque number

  // Attendance
  workingDays Int @default(0)
  presentDays Int @default(0)
  absentDays  Int @default(0)
  leaveDays   Int @default(0)

  notes     String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([employeeId, month, year])
  @@index([employeeId])
  @@index([month, year])
  @@index([paymentStatus])
  @@map("salaries")
}

// Attendance Tracking
model Attendance {
  id         String   @id @default(cuid())
  employeeId String
  employee   Employee @relation(fields: [employeeId], references: [id], onDelete: Cascade)

  date      DateTime
  checkIn   DateTime?
  checkOut  DateTime?
  status    AttendanceStatus @default(PRESENT)
  workHours Float? // Calculated work hours
  overtime  Float? // Overtime hours

  notes     String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([employeeId, date])
  @@index([employeeId])
  @@index([date])
  @@index([status])
  @@map("attendances")
}

enum AttendanceStatus {
  PRESENT
  ABSENT
  HALF_DAY
  LEAVE
  HOLIDAY
  SICK_LEAVE
  CASUAL_LEAVE
  WORK_FROM_HOME
}

// Operational Costs/Expenses
model OperationalCost {
  id          String       @id @default(cuid())
  category    CostCategory
  subCategory String? // More specific categorization
  description String
  amount      Float

  // Period
  date  DateTime @default(now())
  month Int // 1-12
  year  Int

  // Payment Details
  paymentStatus    PaymentStatus @default(PENDING)
  paymentDate      DateTime?
  paymentMethod    String?
  paymentReference String? // Invoice number, receipt number

  // Vendor/Supplier
  vendor        String?
  vendorContact String?

  // Approval
  isApproved Boolean   @default(false)
  approvedBy String? // Admin user ID
  approvedAt DateTime?

  // Recurring
  isRecurring     Boolean @default(false)
  recurringPeriod String? // Monthly, Quarterly, Yearly

  notes         String?
  attachmentUrl String? // Receipt/invoice attachment

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([category])
  @@index([month, year])
  @@index([paymentStatus])
  @@index([date])
  @@map("operational_costs")
}

enum CostCategory {
  RENT // Office/warehouse rent
  UTILITIES // Electricity, water, internet
  SALARIES // Employee salaries
  MARKETING // Advertising, promotions
  SHIPPING // Delivery and logistics
  PACKAGING // Packaging materials
  OFFICE_SUPPLIES // Stationery, equipment
  MAINTENANCE // Repairs, servicing
  INSURANCE // Business insurance
  TAXES // Business taxes
  LEGAL // Legal fees
  SOFTWARE // Software subscriptions
  INVENTORY // Inventory purchase costs
  TRANSPORTATION // Vehicle fuel, maintenance
  COMMUNICATION // Phone, internet bills
  TRAINING // Employee training
  ENTERTAINMENT // Client entertainment
  BANK_CHARGES // Banking fees
  DEPRECIATION // Asset depreciation
  MISCELLANEOUS // Other expenses
}

// Comprehensive Profit & Loss Report
model ProfitLossReport {
  id String @id @default(cuid())

  // Period
  month     Int // 1-12
  year      Int
  startDate DateTime
  endDate   DateTime

  // Revenue
  totalRevenue  Float // Total sales revenue
  returnRevenue Float @default(0) // Revenue from returns
  netRevenue    Float // Total - Returns

  // Cost of Goods Sold (COGS)
  openingStock Float @default(0)
  purchases    Float @default(0) // Inventory purchases
  closingStock Float @default(0)
  cogs         Float // Opening + Purchases - Closing

  // Gross Profit
  grossProfit Float // Net Revenue - COGS
  grossMargin Float // (Gross Profit / Net Revenue) * 100

  // Operating Expenses
  salaryExpense          Float @default(0)
  rentExpense            Float @default(0)
  utilitiesExpense       Float @default(0)
  marketingExpense       Float @default(0)
  shippingExpense        Float @default(0)
  otherExpenses          Float @default(0)
  totalOperatingExpenses Float

  // Operating Profit
  operatingProfit Float // Gross Profit - Operating Expenses
  operatingMargin Float // (Operating Profit / Net Revenue) * 100

  // Net Profit
  netProfit Float // Operating Profit - Other Expenses
  netMargin Float // (Net Profit / Net Revenue) * 100

  // Additional Metrics
  orderCount        Int   @default(0)
  customerCount     Int   @default(0)
  averageOrderValue Float @default(0)

  generatedAt DateTime @default(now())
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@unique([month, year])
  @@index([month, year])
  @@map("profit_loss_reports")
}

// Business Partners - Profit Sharing Management
model Partner {
  id    String  @id @default(cuid())
  name  String // Partner name
  email String? @unique
  phone String?

  // Profit Share Configuration
  profitSharePercentage Float // Percentage of net profit (0-100)
  isActive              Boolean @default(true)

  // Partnership Details
  partnerType String? // INVESTOR, CO-OWNER, SILENT_PARTNER, etc.
  joinDate    DateTime  @default(now())
  exitDate    DateTime?

  // Financial
  initialInvestment   Float? // Initial capital invested
  totalProfitReceived Float  @default(0) // Total profit distributed

  // Contact & Legal
  address     String?
  taxId       String?
  bankAccount String?

  notes String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  profitDistributions ProfitDistribution[]

  @@index([isActive])
  @@map("partners")
}

// Profit Distribution Records
model ProfitDistribution {
  id        String @id @default(cuid())
  partnerId String

  // Period
  periodType String // DAILY, WEEKLY, MONTHLY, YEARLY
  startDate  DateTime
  endDate    DateTime

  // Financial Data
  totalRevenue Float
  totalCosts   Float // All operational costs
  netProfit    Float // Revenue - Costs

  partnerShare       Float // Partner's percentage share
  distributionAmount Float // Actual amount to distribute

  // Status
  status           String    @default("PENDING") // PENDING, APPROVED, PAID
  approvedBy       String?
  approvedAt       DateTime?
  paidAt           DateTime?
  paymentMethod    String?
  paymentReference String?

  notes String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  partner Partner @relation(fields: [partnerId], references: [id], onDelete: Cascade)

  @@index([partnerId])
  @@index([periodType])
  @@index([startDate, endDate])
  @@index([status])
  @@map("profit_distributions")
}

// Data Deletion Request Model (for GDPR/Google Play compliance)
model DataDeletionRequest {
  id              String                @id @default(cuid())
  userId          String
  user            User                  @relation(fields: [userId], references: [id], onDelete: Cascade)
  email           String
  phone           String
  reason          String?
  status          DeletionRequestStatus @default(PENDING)
  requestedAt     DateTime              @default(now())
  processedAt     DateTime?
  processedBy     String? // Admin user ID who processed the request
  completedAt     DateTime?
  rejectedAt      DateTime?
  rejectionReason String?
  ipAddress       String?
  userAgent       String?
  notes           String? // Admin notes
  createdAt       DateTime              @default(now())
  updatedAt       DateTime              @updatedAt

  // Relations
  auditLogs DataDeletionAuditLog[]

  @@index([userId])
  @@index([status])
  @@index([email])
  @@map("data_deletion_requests")
}

// Data Deletion Audit Log - Track all actions on deletion requests
model DataDeletionAuditLog {
  id             String                 @id @default(cuid())
  requestId      String
  request        DataDeletionRequest    @relation(fields: [requestId], references: [id], onDelete: Cascade)
  adminId        String
  action         String // CREATED, APPROVED, REJECTED, EXECUTED, etc.
  previousStatus DeletionRequestStatus?
  newStatus      DeletionRequestStatus?
  metadata       Json? // Additional context (reason, notes, etc.)
  timestamp      DateTime               @default(now())

  @@index([requestId])
  @@index([adminId])
  @@index([action])
  @@map("data_deletion_audit_logs")
}

// Product Reviews - Only verified purchasers can review
model Review {
  id        String   @id @default(cuid())
  productId String
  userId    String
  orderId   String // Link to order for verification
  
  // Review content
  rating    Int // 1-5 stars
  title     String? // Review headline
  comment   String // Review text
  images    String[] @default([]) // Optional review images
  
  // Verification
  isVerifiedPurchase Boolean @default(true) // Verified purchaser
  purchaseDate       DateTime? // When they bought the product
  
  // Moderation
  status       ReviewStatus @default(PENDING) // PENDING, APPROVED, HIDDEN, REJECTED
  moderatedBy  String? // Admin who moderated
  moderatedAt  DateTime?
  moderationNote String? // Admin note for moderation decision
  
  // Helpfulness tracking
  helpfulCount   Int @default(0) // How many found it helpful
  notHelpfulCount Int @default(0)
  
  // Metadata
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  // Relations
  product   Product @relation(fields: [productId], references: [id], onDelete: Cascade)
  user      User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  order     Order   @relation(fields: [orderId], references: [id], onDelete: Cascade)
  
  @@unique([userId, productId, orderId]) // One review per user per product per order
  @@index([productId])
  @@index([userId])
  @@index([status])
  @@index([rating])
  @@index([createdAt])
  @@map("reviews")
}

enum ReviewStatus {
  PENDING   // Awaiting moderation
  APPROVED  // Published and visible
  HIDDEN    // Hidden by moderator but not deleted
  REJECTED  // Rejected by moderator
}

// Financial Ledger Enums
enum LedgerSourceType {
  ORDER          // Revenue from customer order
  EXPENSE        // Operational expense
  SALARY         // Employee salary payment
  ADJUSTMENT     // Manual correction/adjustment
  REFUND         // Customer refund
  PURCHASE       // Inventory purchase
  RETURN         // Customer return
  FEE            // Platform/transaction fees
  COMMISSION     // Partner commission payout
  INVESTMENT     // Capital investment
  WITHDRAWAL     // Capital withdrawal
  TAX            // Tax payment
  UTILITY        // Utility bills
  RENT           // Rent payment
  MARKETING      // Marketing expenses
  SHIPPING       // Shipping costs
  MANUAL_SALE    // Manual sales entry
  OTHER          // Miscellaneous
}

enum LedgerDirection {
  DEBIT          // Money out (expenses, costs)
  CREDIT         // Money in (revenue, income)
}

// Financial Ledger - Append-Only Audit Log
model FinancialLedger {
  id              String               @id @default(cuid())
  
  // Transaction Source
  sourceType      LedgerSourceType     // Type of transaction
  sourceId        String               // Reference ID
  sourceName      String?              // Human-readable reference
  
  // Financial Data
  amount          Float                // Always positive
  direction       LedgerDirection      // DEBIT or CREDIT
  currency        String               @default("BDT")
  
  // Categorization
  category        String?
  subcategory     String?
  
  // Parties
  partyId         String?
  partyName       String?
  partyType       String?
  
  // Metadata
  description     String?
  notes           String?
  metadata        Json?
  
  // Audit
  createdAt       DateTime             @default(now())
  createdBy       String?
  fiscalYear      Int?
  fiscalMonth     Int?
  
  // Reconciliation
  isReconciled    Boolean              @default(false)
  reconciledAt    DateTime?
  reconciledBy    String?
  
  // Relations
  orderId         String?
  order           Order?               @relation(fields: [orderId], references: [id], onDelete: SetNull)
  
  @@index([sourceType])
  @@index([sourceId])
  @@index([direction])
  @@index([createdAt])
  @@index([fiscalYear, fiscalMonth])
  @@index([orderId])
  @@index([isReconciled])
  @@map("financial_ledger")
}
// Stock Lot Tracking for FIFO/WAC Costing
model StockLot {
  id              String   @id @default(cuid())
  productId       String
  
  // Purchase/Restock Details
  lotNumber       String   // Auto-generated or manual
  purchaseDate    DateTime @default(now())
  expiryDate      DateTime? // For perishable goods
  
  // Cost Information
  quantityReceived Int      // Original quantity
  quantityRemaining Int     // Current available
  costPerUnit      Float    // Buying cost per unit
  totalCost        Float    // Total purchase cost
  
  // Supplier Information
  supplierId       String?
  supplierName     String?
  purchaseOrderRef String?  // PO reference
  
  // Warehouse
  warehouseId      String   @default("default")
  
  // Metadata
  notes            String?
  createdBy        String   // User who created restock entry
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
  
  // Relations
  product          Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  allocations      StockAllocation[] // Track which orders consumed this lot
  
  @@index([productId])
  @@index([purchaseDate])
  @@index([lotNumber])
  @@map("stock_lots")
}

// Stock Allocation Tracking (Audit Trail for COGS)
model StockAllocation {
  id          String   @id @default(cuid())
  lotId       String
  orderId     String
  orderItemId String
  quantity    Int      // Quantity allocated from this lot
  costPerUnit Float    // Cost at time of allocation (snapshot)
  allocatedAt DateTime @default(now())
  
  // Relations
  lot         StockLot  @relation(fields: [lotId], references: [id], onDelete: Cascade)
  
  @@index([lotId])
  @@index([orderId])
  @@index([orderItemId])
  @@map("stock_allocations")
}

// Manual Sales Entry - For recording offline/external sales
model ManualSalesEntry {
  id              String   @id @default(cuid())
  
  // Sale Information
  saleDate        DateTime // Date of actual sale
  referenceNumber String?  // Invoice/Receipt number
  saleType        String   @default("OFFLINE") // OFFLINE, PHONE_ORDER, WHOLESALE_DIRECT, etc.
  
  // Customer Information (Optional)
  customerId      String?
  customerName    String?
  customerPhone   String?
  customerCompany String?
  
  // Financial Summary
  subtotal        Float    @default(0)
  discount        Float    @default(0)
  tax             Float    @default(0)
  shipping        Float    @default(0)
  total           Float    // Total sale amount
  totalCost       Float    // Total cost (COGS)
  totalProfit     Float    // Calculated profit
  profitMargin    Float    // Profit percentage
  
  // Payment Details
  paymentMethod   String?  // CASH, BANK_TRANSFER, MOBILE_PAYMENT, etc.
  paymentStatus   String   @default("PAID") // PAID, PENDING, PARTIAL
  amountPaid      Float?   // If partial payment
  
  // Inventory Impact
  adjustInventory Boolean  @default(true) // Whether to reduce stock
  inventoryAdjusted Boolean @default(false) // Has stock been adjusted
  
  // Metadata
  notes           String?
  attachments     String[] // Receipt images, invoices, etc.
  
  // Audit
  enteredBy       String   // Admin who entered this sale
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  // Relations
  customer        User?               @relation("ManualSalesCustomer", fields: [customerId], references: [id], onDelete: SetNull)
  items           ManualSalesItem[]
  enteredByUser   User                @relation("SaleEnteredBy", fields: [enteredBy], references: [id], onDelete: Restrict)
  
  @@index([saleDate])
  @@index([customerId])
  @@index([enteredBy])
  @@index([saleType])
  @@index([createdAt])
  @@map("manual_sales_entries")
}

// Manual Sales Items - Products sold in manual entry
model ManualSalesItem {
  id              String   @id @default(cuid())
  saleEntryId     String
  
  // Product Information
  productId       String
  productName     String   // Snapshot at time of sale
  productSku      String?  // Snapshot at time of sale
  
  // Quantity & Pricing
  quantity        Int      // Quantity sold
  unitPrice       Float    // Selling price per unit
  costPerUnit     Float    // Cost price per unit (for profit calc)
  
  // Calculations
  subtotal        Float    // quantity × unitPrice
  discount        Float    @default(0) // Item-level discount
  total           Float    // subtotal - discount
  totalCost       Float    // quantity × costPerUnit
  profit          Float    // total - totalCost
  profitMargin    Float    // (profit / total) × 100
  
  // Metadata
  notes           String?
  
  // Relations
  saleEntry       ManualSalesEntry @relation(fields: [saleEntryId], references: [id], onDelete: Cascade)
  product         Product          @relation(fields: [productId], references: [id], onDelete: Restrict)
  
  @@index([saleEntryId])
  @@index([productId])
  @@map("manual_sales_items")
}